{% extends "base_admin.html" %}

{% block title %}Gestión de Canal de Noticias{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    
    <header class="mb-4 d-flex justify-content-between align-items-center">
        <h1 class="h3">Administración del Canal de Noticias</h1>
        <button class="btn btn-success" data-toggle="modal" data-target="#crearPublicacionModal">
            <i class="fas fa-plus-circle"></i> Nueva Publicación
        </button>
    </header>

    <ul class="nav nav-tabs" id="publicacionTabs" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" id="activas-tab" data-toggle="tab" href="#activas" role="tab">
                Publicaciones Activas
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="borradores-tab" data-toggle="tab" href="#borradores" role="tab">
                Borradores
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="archivadas-tab" data-toggle="tab" href="#archivadas" role="tab">
                Archivadas
            </a>
        </li>
    </ul>

    <div class="tab-content mt-3" id="publicacionTabsContent">
        
        <div class="tab-pane fade show active" id="activas" role="tabpanel">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Noticias Visibles para Empleados</h6>
                </div>
                <div class="card-body">
                    {% if publicaciones_activas %}
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover" id="activasTable" width="100%" cellspacing="0">
                            <thead>
                                <tr>
                                    <th>Título</th>
                                    <th>Autor</th>
                                    <th>Fecha Publicación</th>
                                    <th>Vigencia</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for publicacion in publicaciones_activas %}
                                <tr>
                                    <td>{{ publicacion.Titulo }}</td>
                                    <td>{{ publicacion.Autor }}</td>
                                    <td>{{ publicacion.FechaPublicacion | default("Inmediata") }}</td>
                                    <td>{{ publicacion.FechaVigencia | default("Indefinida") }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-warning" title="Editar" 
                                                data-toggle="modal" data-target="#crearPublicacionModal"
                                                data-publicacion-id="{{ publicacion.IdPublicacion }}">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <a href="{{ url_for('cambiar_estado_publicacion', id=publicacion.IdPublicacion, estado='Archivada') }}" 
                                        class="btn btn-sm btn-secondary" title="Archivar">
                                            <i class="fas fa-archive"></i>
                                        </a>
                                        <button class="btn btn-sm btn-danger" title="Eliminar" onclick="confirmarEliminacion('{{ publicacion.IdPublicacion }}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-info text-center">
                        No hay publicaciones activas en este momento. ¡Crea una nueva!
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="tab-pane fade" id="borradores" role="tabpanel">
             <p>Aquí se listarán las publicaciones en estado 'Borrador' o 'Pendiente'.</p>
        </div>

        <div class="tab-pane fade" id="archivadas" role="tabpanel">
            <p>Aquí se listarán las publicaciones en estado 'Archivada' o 'Inactiva'.</p>
        </div>

    </div>
</div>

{% include "modals/crear_publicacion.html" %} 

{% endblock %}

{% block scripts %}
    {{ super() }}
    
    <script>
        function confirmarEliminacion(id) {
            if (confirm("¿Estás seguro de que quieres ELIMINAR definitivamente esta publicación? Esta acción no se puede deshacer.")) {
                // Redirigir a un endpoint de eliminación
                window.location.href = "{{ url_for('eliminar_publicacion') }}" + "?id=" + id;
            }
        }
        
        // Lógica de JavaScript para precargar datos en el modal de edición
        $('#crearPublicacionModal').on('show.bs.modal', function (event) {
            var button = $(event.relatedTarget);
            var publicacionId = button.data('publicacion-id'); // Obtiene el ID si es una edición

            if (publicacionId) {
                // Lógica AJAX para obtener los datos de la publicación por ID y rellenar el formulario
                // fetch('/api/publicacion/' + publicacionId) ...
                
                $('#crearPublicacionModalLabel').text('Editar Publicación');
                $('#btnGuardarPublicacion').text('Guardar Cambios');
                
                // (Se necesita AJAX para rellenar los campos aquí)

            } else {
                // Configuración para nuevo
                $('#crearPublicacionModalLabel').text('Crear Nueva Publicación');
                $('#btnGuardarPublicacion').text('Publicar');
                // Asegurar que el formulario esté limpio
                $('#formPublicacion')[0].reset();
            }
        });
    </script>
{% endblock %}