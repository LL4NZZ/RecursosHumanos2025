{% extends 'base_admin.html' %}

{% block title %}Reportes de Asistencia{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <h2 class="mb-4 fw-bold text-primary">ðŸ“Š Reportes de Asistencia</h2>

    <form action="{{ url_for('reportes_asistencia') }}" method="GET" class="row g-3 mb-5 p-3 shadow-sm bg-light rounded">
        
        <div class="col-md-4">
            <label for="usuario_id" class="form-label fw-semibold">Filtrar por Empleado</label>
            <select class="form-select" id="usuario_id" name="usuario_id">
                <option value="">â€” Todos los Empleados â€”</option>
                {% for user in all_users %}
                    <option value="{{ user.IdUsuario }}" 
                            {% if current_user_id and current_user_id | string == user.IdUsuario | string %}selected{% endif %}>
                        {{ user.Nombres }} {{ user.Apellidos }}
                    </option>
                {% endfor %}
            </select>
        </div>
        
        <div class="col-md-3">
            <label for="fecha_inicio" class="form-label fw-semibold">Desde</label>
            <input type="date" class="form-control" id="fecha_inicio" name="fecha_inicio" value="{{ fecha_inicio or '' }}">
        </div>
        
        <div class="col-md-3">
            <label for="fecha_fin" class="form-label fw-semibold">Hasta</label>
            <input type="date" class="form-control" id="fecha_fin" name="fecha_fin" value="{{ fecha_fin or '' }}">
        </div>
        
        <div class="col-md-2 d-flex align-items-end justify-content-end">
            <button type="submit" class="btn btn-primary w-100 me-2">
                <i class="fa-solid fa-filter me-1"></i> Aplicar
            </button>
            <a href="{{ url_for('reportes_asistencia') }}" class="btn btn-outline-secondary w-100">
                <i class="fa-solid fa-times me-1"></i> Limpiar
            </a>
        </div>
    </form>

    <div class="mb-4 d-flex justify-content-end">
        <a href="{{ url_for('export_csv') }}" class="btn btn-success me-2 shadow-sm">
            <i class="fa-solid fa-file-csv me-1"></i> Exportar CSV
        </a>
        <a href="{{ url_for('export_pdf') }}" class="btn btn-danger shadow-sm">
            <i class="fa-solid fa-file-pdf me-1"></i> Exportar PDF
        </a>
    </div>

    <div class="card p-3 mb-4 shadow-lg">
        <h5 class="fw-bold mb-3">Detalles de Registros ({{ asistencias | length }} Encontrados)</h5>
        
        <div class="table-responsive" style="max-height: 400px;">
            <table class="table table-striped table-hover table-sm">
                <thead class="table-primary sticky-top">
                    <tr>
                        <th style="width: 5%;">ID</th>
                        <th style="width: 25%;">Empleado</th>
                        <th style="width: 10%;">Fecha</th>
                        <th style="width: 10%;">Entrada</th>
                        <th style="width: 10%;">Salida</th>
                        <th style="width: 10%;">Descanso</th>
                        <th style="width: 20%;">Estado</th>
                    </tr>
                </thead>
                <tbody>
                {% for a in asistencias %}
                    <tr>
                        <td>{{ a.IdAsistencia }}</td>
                        <td>{{ a.Nombres }} {{ a.Apellidos }}</td>
                        <td>{{ a.Fecha }}</td>
                        <td>{{ a.HoraEntrada or '-' }}</td>
                        <td>{{ a.HoraSalida or '-' }}</td>
                        <td>{{ a.Descanso or '-' }}</td>
                        <td>
                            {% set status = a.Estado.lower() %}
                            {% if 'completa' in status %}
                                <span class="badge bg-success">{{ a.Estado }}</span>
                            {% elif 'pendiente' in status %}
                                <span class="badge bg-warning text-dark">{{ a.Estado }}</span>
                            {% elif 'falta' in status %}
                                <span class="badge bg-danger">{{ a.Estado }}</span>
                            {% else %}
                                <span class="badge bg-info">{{ a.Estado }}</span>
                            {% endif %}
                        </td>
                    </tr>
                {% else %}
                    <tr>
                        <td colspan="7" class="text-center text-muted">No se encontraron registros de asistencia en el perÃ­odo y filtro seleccionado.</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-md-4">
            <div class="card p-3 shadow-sm h-100">
                <h5 class="fw-bold">DistribuciÃ³n de Estados</h5>
                <canvas id="estadosChart"></canvas>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card p-3 shadow-sm h-100">
                <h5 class="fw-bold">Horas Trabajadas por Empleado</h5>
                <canvas id="horasChart"></canvas>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card p-3 shadow-sm h-100">
                <h5 class="fw-bold">Registros de Asistencia por DÃ­a</h5>
                <canvas id="diasChart"></canvas>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script id="report-data" type="application/json">
{{ {'estados': estados, 'horas': horas, 'por_dia': por_dia} | tojson }}
</script>

<script>
    // CÃ³digo de grÃ¡ficos (no necesita cambios)
    const parsed = JSON.parse(document.getElementById("report-data").textContent);

    // Pie - Estados
    new Chart(document.getElementById("estadosChart"), {
      type: "pie",
      data: {
        labels: Object.keys(parsed.estados),
        datasets: [{ data: Object.values(parsed.estados), backgroundColor: ["#28a745", "#ffc107", "#dc3545", "#6c757d"] }]
      }
    });

    // Barras - Horas por empleado
    new Chart(document.getElementById("horasChart"), {
      type: "bar",
      data: {
        labels: Object.keys(parsed.horas),
        datasets: [{ label: "Horas", data: Object.values(parsed.horas), backgroundColor: "#0d6efd" }]
      },
      options: { scales: { y: { beginAtZero: true } } }
    });

    // Barras - Asistencia por dÃ­a
    new Chart(document.getElementById("diasChart"), {
      type: "bar",
      data: {
        labels: Object.keys(parsed.por_dia),
        datasets: [{ label: "Asistencias", data: Object.values(parsed.por_dia), backgroundColor: "#20c997" }]
      },
      options: { scales: { y: { beginAtZero: true } } }
    });
</script>
{% endblock %}