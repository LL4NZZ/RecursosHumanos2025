{% extends 'base_admin.html' %}

{% block title %}Agregar Usuario{% endblock %}
{% block page_title %}Gesti√≥n de Usuarios{% endblock %}

{% block content %}

<div class="card p-4 mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="m-0 fw-bold">‚ûï Registrar Usuario</h3>
        <a href="{{ url_for('modulo_usuarios') }}" class="btn btn-outline-secondary">
            <i class="fa-solid fa-arrow-left me-2"></i> Volver
        </a>
    </div>

    <form method="POST" class="row g-3" id="formUsuario">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

        <!-- Nombres -->
        <div class="col-md-6">
            <label class="form-label">Nombres *</label>
            <input type="text" class="form-control required" name="nombres">
        </div>

        <!-- Apellidos -->
        <div class="col-md-6">
            <label class="form-label">Apellidos *</label>
            <input type="text" class="form-control required" name="apellidos">
        </div>

        <!-- Tipo documento -->
        <div class="col-md-6">
            <label class="form-label">Tipo Documento *</label>
            <select class="form-select required" name="tipoDocumento" id="tipoDocumento">
                <option value="">Seleccione...</option>
                <option value="CC">C√©dula de Ciudadan√≠a</option>
                <option value="CE">C√©dula de Extranjer√≠a</option>
                <option value="TI">Tarjeta de Identidad</option>
                <option value="PP">Pasaporte</option>
            </select>
        </div>

        <!-- Documento -->
        <div class="col-md-6">
            <label class="form-label">Documento *</label>
            <input type="text" class="form-control required" name="documento" id="documento">
        </div>

        <!-- Correo -->
        <div class="col-md-6">
            <label class="form-label">Correo *</label>
            <input type="email" class="form-control required" name="correo">
        </div>

        <!-- Correo corporativo -->
        <div class="col-md-6">
            <label class="form-label">Correo Corporativo</label>
            <input type="email" class="form-control" name="correo_corporativo">
        </div>

        <!-- Tel√©fono -->
        <div class="col-md-6">
            <label class="form-label">Tel√©fono *</label>
            <input type="tel" class="form-control required" name="telefono">
        </div>

        <!-- Rol -->
        <div class="col-md-6">
            <label class="form-label">Rol *</label>
            <select class="form-select required" name="idRol" id="selectRol">
                <option value="" disabled selected>Seleccione el Rol...</option>
                {% for rol_item in roles %}
                <option value="{{ rol_item.IdRol }}" data-rol="{{ rol_item.NombreRol }}">
                    {{ rol_item.NombreRol }}
                </option>
                {% endfor %}
            </select>
        </div>

        <!-- Fecha contrataci√≥n -->
        <div class="col-md-6">
            <label class="form-label">Fecha Contrataci√≥n</label>
            <input type="date" class="form-control" name="fechaContratacion" id="fechaContratacion">
        </div>

        <!-- Fecha nacimiento -->
        <div class="col-md-6">
            <label class="form-label">Fecha Nacimiento</label>
            <input type="date" class="form-control" name="fechaNacimiento">
        </div>

        <!-- Contrase√±a -->
        <div class="col-12 position-relative">
            <label class="form-label">Contrase√±a *</label>
            <input type="password" class="form-control required" name="contrasena" id="contrasena">

            <button type="button" id="togglePass" class="btn btn-sm btn-light position-absolute"
                style="right:10px; top:32px;">
                <i id="iconEye" class="fa-solid fa-eye-slash"></i>
            </button>
        </div>

        <!-- Bot√≥n registrar -->
        <div class="col-12 text-end">
            <button type="submit" class="btn btn-primary w-100">
                <i class="fa-solid fa-check me-2"></i> Registrar Usuario
            </button>
        </div>
    </form>
</div>

<script>
/* Solo letras en nombre y apellido */
document.querySelectorAll("input[name='nombres'], input[name='apellidos']").forEach(campo => {
    campo.addEventListener("input", () => {
        campo.value = campo.value.replace(/[^A-Za-z√Å√â√ç√ì√ö√°√©√≠√≥√∫√±√ë\s]/g, "");
    });
});

/* Solo n√∫meros */
document.querySelectorAll("#documento, input[name='telefono']").forEach(campo => {
    campo.addEventListener("input", () => {
        campo.value = campo.value.replace(/[^0-9]/g, "");
    });
});

document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("formUsuario");
    const fechaNacimiento = document.querySelector("input[name='fechaNacimiento']");
    const fechaContratacion = document.getElementById("fechaContratacion");
    const hoy = new Date().toISOString().split("T")[0];

    fechaContratacion.setAttribute("min", hoy);
    fechaNacimiento.setAttribute("max", hoy);

    /* üî• Cuando el usuario escribe, se quita el rojo autom√°ticamente */
    document.querySelectorAll(".required").forEach(campo => {
        campo.addEventListener("input", () => {
            if (campo.value.trim() !== "") {
                campo.classList.remove("is-invalid");
            }
        });
    });

    form.addEventListener("submit", (e) => {
        let errores = false;

        /* Validaci√≥n campos requeridos */
        document.querySelectorAll(".required").forEach(campo => {
            campo.classList.remove("is-invalid");

            if (campo.value.trim() === "") {
                campo.classList.add("is-invalid");
                errores = true;
            }
        });

        /* Validaci√≥n fechas */
        if (fechaNacimiento.value && fechaNacimiento.value > hoy) {
            alert("‚ö† La fecha de nacimiento no puede ser futura.");
            errores = true;
        }

        if (fechaContratacion.value && fechaContratacion.value < hoy) {
            alert("‚ö† La fecha de contrataci√≥n no puede ser anterior a hoy.");
            errores = true;
        }

        if (errores) e.preventDefault();
    });
});

/* Mostrar/ocultar contrase√±a */
document.getElementById("togglePass").addEventListener("click", () => {
    const passField = document.getElementById("contrasena");
    const icon = document.getElementById("iconEye");

    passField.type = passField.type === "password" ? "text" : "password";
    icon.classList.toggle("fa-eye");
    icon.classList.toggle("fa-eye-slash");
});
</script>

{% endblock %}
