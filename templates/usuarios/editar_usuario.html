{% extends 'base_admin.html' %}

{% block title %}Editar Usuario{% endblock %}
{% block page_title %}Editar Usuario{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="card shadow-lg p-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="m-0 fw-bold">
                ‚úèÔ∏è Editar Usuario: <span class="text-primary">{{ usuario.Nombres }} {{ usuario.Apellidos }}</span>
            </h3>
            <a href="{{ url_for('usuarios') }}" class="btn btn-outline-secondary">
                <i class="fa-solid fa-arrow-left me-2"></i> Volver a Usuarios
            </a>
        </div>

        <!-- FORMULARIO -->
        <form action="{{ url_for('edit_usuario', id=usuario.IdUsuario) }}" method="POST" class="row g-3"
            id="formEditUsuario">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

            <!-- Secci√≥n Datos Personales -->
            <h5 class="fw-bold text-secondary mt-3">üìå Datos personales</h5>
            <hr>

            <div class="col-md-4">
                <label class="form-label">Rol *</label>
                <select class="form-select required" name="idRol" id="idRol">
                    <option disabled>Seleccione...</option>
                    {% for rol_item in roles %}
                    <option value="{{ rol_item.IdRol }}" {% if rol_item.IdRol==usuario.IdRol %}selected{% endif %}>
                        {{ rol_item.NombreRol }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-4">
                <label class="form-label">Nombres *</label>
                <input type="text" class="form-control required" name="nombres" value="{{ usuario.Nombres }}">
            </div>

            <div class="col-md-4">
                <label class="form-label">Apellidos *</label>
                <input type="text" class="form-control required" name="apellidos" value="{{ usuario.Apellidos }}">
            </div>

            <div class="col-md-6">
                <label class="form-label">Tipo Documento *</label>
                <input type="text" class="form-control required" name="tipoDocumento"
                    value="{{ usuario.TipoDocumento }}">
            </div>

            <div class="col-md-6">
                <label class="form-label">Documento *</label>
                <input type="text" class="form-control required" name="documento" value="{{ usuario.Documento }}">
            </div>

            <!-- Secci√≥n Contacto -->
            <h5 class="fw-bold text-secondary mt-4">üìû Informaci√≥n de contacto</h5>
            <hr>

            <div class="col-md-6">
                <label class="form-label">Correo *</label>
                <input type="email" class="form-control required" name="correo" value="{{ usuario.Correo }}">
            </div>

            <div class="col-md-6" id="correoCorpContainer">
                <label class="form-label">Correo Corporativo</label>
                <input type="email" class="form-control" name="correo_corporativo"
                    value="{{ usuario.CorreoCorporativo }}">
            </div>

            <div class="col-md-6">
                <label class="form-label">Tel√©fono *</label>
                <input type="text" class="form-control required" name="telefono" value="{{ usuario.Telefono }}">
            </div>

            <div class="col-md-6">
                <label class="form-label">Fecha de Contrataci√≥n</label>
                <input type="date" class="form-control" id="fechaContratacion" name="fechaContratacion"
                    value="{{ usuario.FechaContratacion }}">
            </div>

            <div class="col-md-6">
                <label class="form-label">Fecha de Nacimiento *</label>
                <input type="date" class="form-control required" id="fechaNacimiento" name="fechaNacimiento"
                    value="{{ usuario.FechaNacimiento }}">
            </div>

            <!-- Secci√≥n Acceso -->
            <h5 class="fw-bold text-secondary mt-4">üîê Acceso al sistema</h5>
            <hr>

            <div class="col-md-6 position-relative">
                <label class="form-label">Contrase√±a (dejar vac√≠o para no modificar)</label>
                <input type="password" class="form-control" id="contrasena" name="contrasena">

                <!-- Bot√≥n mostrar/ocultar -->
                <button type="button" id="togglePass" class="btn btn-sm btn-light position-absolute"
                    style="right:10px; top:35px;">
                    <i class="fa-solid fa-eye-slash"></i>
                </button>
            </div>

            <!-- Bot√≥n actualizar -->
            <div class="col-12 mt-4 text-end">
                <button type="submit" class="btn btn-warning px-4">
                    <i class="fa-solid fa-floppy-disk me-2"></i> Guardar Cambios
                </button>
            </div>

        </form>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {

        // ‚úÖ Mostrar/ocultar contrase√±a
        document.getElementById("togglePass").addEventListener("click", () => {
            let pass = document.getElementById("contrasena");
            let icon = document.querySelector("#togglePass i");

            pass.type = pass.type === "password" ? "text" : "password";
            icon.classList.toggle("fa-eye");
            icon.classList.toggle("fa-eye-slash");
        });

        // ‚úÖ Fecha no futura para nacimiento
        const today = new Date().toISOString().split("T")[0];
        document.getElementById("fechaNacimiento").setAttribute("max", today);

        // ‚úÖ Validaci√≥n de campos obligatorios en el EDITAR
        const form = document.getElementById("formEditUsuario");

        form.addEventListener("submit", (e) => {
            let errores = false;

            document.querySelectorAll(".required").forEach(campo => {

                campo.classList.remove("is-invalid");

                // ‚ùå Si est√° vac√≠o ‚Üí marcar error
                if (campo.value.trim() === "") {
                    campo.classList.add("is-invalid");
                    errores = true;

                    // Si no existe mensaje de error, lo agregamos
                    if (!campo.nextElementSibling || !campo.nextElementSibling.classList.contains("invalid-feedback")) {
                        campo.insertAdjacentHTML(
                            "afterend",
                            `<div class="invalid-feedback">‚ö† Este campo es obligatorio.</div>`
                        );
                    }
                }
            });

            if (errores) {
                e.preventDefault();
                alert("‚ö† Debes completar todos los campos obligatorios.");
            }
        });

        // ‚úÖ Validaci√≥n visual en tiempo real (quita error mientras escriben)
        document.querySelectorAll(".required").forEach(campo => {
            campo.addEventListener("input", () => {
                if (campo.value.trim() !== "") {
                    campo.classList.remove("is-invalid");
                }
            });
        });
    });
</script>

{% endblock %}